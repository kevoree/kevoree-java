<html>
<head>
    <script type="text/javascript" src="org.kevoree.modeling.microframework.browser.js"></script>
    <script type="text/javascript" src="org.kevoree.modeling.drivers.websocket.js"></script>
    <script type="text/javascript" src="model.js"></script>
    <script type="text/javascript" src="paperclip.js"></script>
    <script type="text/javascript" src="parser.js"></script>
</head>
<body>

<template id="NodesView">
    <h3>Nodes:</h3>
    <ul>
        <repeat each={{modelRoot.nodes}} as="node">
            <li>{{node.name}}
                <ul>
                    <li>Metrics
                        <ul>
                            <repeat each={{node.metrics}} as="metric">
                                <li>name:{{metric.name}}, value:{{metric.value}}</li>
                            </repeat>
                        </ul>
                    </li>
                    <li>Actions:
                        <ul>
                            <li>
                                <button onclick="{{node | addNowInstance}}">AddNow Instance</button>
                            </li>
                            <li>
                                <button onclick="{{node | add10SecInstance}}">Add10Secondes Instance</button>
                            </li>
                        </ul>
                    </li>
                    <li>Instances
                        <ul>
                            <repeat each={{node.instances}} as="instance">
                                <li>{{instance.name}}</li>
                            </repeat>
                        </ul>
                    </li>
                </ul>
            </li>
        </repeat>
    </ul>
</template>

<h2>Kevoree Server Dashboard</h2>

<div id='nodeView'></div>

<script>
    var wsClient = new org.kevoree.modeling.drivers.websocket.WebSocketPeer("ws://" + window.location.hostname + ":3080/shared");
    var dataManager = org.kevoree.modeling.memory.manager.DataManagerBuilder.create().withContentDeliveryDriver(wsClient).build();
    var model = new org.KevoreeModel(dataManager);
    model.connect(function () {

        var modelContext = model.createModelContext();
        modelContext.set(Date.now(), org.kevoree.modeling.KConfig.END_OF_TIME, 0, 0);

        model.manager().getRoot(0, Date.now(), function (modelRoot) {
            var html = document.getElementById("NodesView").innerHTML;
            var t = paperclip.template(html);
            paperclip.modifiers.addNowInstance = function (node) {
                return function () {
                    var now = Date.now();
                    node.jump(now, function (nowNode) {
                        var newInstance = model.createInstance(0,now);
                        newInstance.setName("instance_"+Math.abs(Math.random()*1000));
                        nowNode.addInstances(newInstance);
                        //propagate changes
                        model.save(null);
                        //just to refresh the template by moving the time machine to now
                        modelContext.set(now, org.kevoree.modeling.KConfig.END_OF_TIME, 0, 0);
                    });
                };
            };
            paperclip.modifiers.add10SecInstance = function (node) {
                return function () {
                    var now = Date.now() + 10 * 1000;
                    node.jump(now, function (nowNode) {
                        var newInstance = model.createInstance(0,now);
                        newInstance.setName("instance_"+Math.abs(Math.random()*1000));
                        nowNode.addInstances(newInstance);
                        //propagate changes, immediately
                        model.save(null);
                        //just to refresh the template by moving the time machine to now
                        setTimeout(function(){
                            modelContext.set(now, org.kevoree.modeling.KConfig.END_OF_TIME, 0, 0);
                        },10 * 1000);
                    });
                };
            };
            var v = t.view({
                modelRoot: modelRoot,
                model: model
            }, {modelContext: modelContext});
            document.getElementById('nodeView').appendChild(v.render());
        });
    });
</script>

</body>
</html>